{% extends 'base.html' %}
{% block title %}Личный кабинет — Тесты{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto pt-10">
  <!-- Приветствие -->
  <div class="bg-gradient-to-tr from-blue-100 to-violet-50 rounded-2xl shadow p-7 mb-10 flex items-center gap-6">
    <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center shadow-inner border border-blue-200">
      <svg width="38" height="38" fill="none" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" fill="#6366f1"/>
        <path d="M7 13.5L10.5 17L17 10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div>
      <h2 class="text-2xl font-extrabold mb-1">Добро пожаловать, {{ fio }}!</h2>
      <div class="text-gray-600">Ваш личный кабинет</div>
    </div>
  </div>

  <!-- Секция с тестами -->
  <div class="bg-white rounded-2xl shadow-xl p-7">
    <div class="flex items-center gap-3 mb-6">
      <svg width="28" height="28" fill="none" class="text-blue-500" viewBox="0 0 24 24">
        <rect x="4" y="7" width="16" height="10" rx="2.5" fill="#6366f1" />
        <rect x="8" y="5" width="8" height="2" rx="1" fill="#a5b4fc" />
      </svg>
      <span class="text-xl font-semibold tracking-tight">Мои тесты</span>
    </div>

    {% if tests %}
      {% set pass_threshold = 70 %}
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        {% for test in tests %}
          {% set res = user_results.get(test.id) %}
          {% set max_score = (max_by_test.get(test.id) if max_by_test is defined else 0) or 0 %}
          {% set percent = (res.score / max_score * 100) | round(0) if res and max_score > 0 else 0 %}
          {% set has_result = res is not none %}
          {% set is_passed = has_result and (percent >= pass_threshold) %}
          {% set bar_color = 'bg-green-500' if percent >= 70 else ('bg-amber-500' if percent >= 40 else 'bg-rose-500') %}

          <div class="relative flex flex-col bg-gray-50 border border-gray-200 rounded-xl shadow hover:shadow-lg transition p-5 min-h-[170px]">
            <!-- Заголовок с иконкой -->
            <div class="flex items-start gap-3 mb-2">
              <div class="w-10 h-10 rounded-lg bg-gradient-to-tr from-blue-500 to-violet-600 grid place-items-center shadow-inner">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M4 7a2 2 0 0 1 2-2h8l4 4v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7z" stroke="white" stroke-width="1.6"/>
                </svg>
              </div>
              <div class="flex-1">
                <div class="text-base font-bold leading-tight">{{ test.title }}</div>
                <div class="text-gray-500 mt-1 line-clamp-2">{{ test.description or '—' }}</div>
              </div>
            </div>

            {% if has_result %}
              <!-- Бейдж статуса -->
              <div class="flex items-center gap-2 mt-3">
                {% if is_passed %}
                  <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-green-100 text-green-800 text-xs font-semibold">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M6 12l3 3 9-9" stroke="#047857" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    Сдан
                  </span>
                {% else %}
                  <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-rose-100 text-rose-800 text-xs font-semibold">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6L6 18" stroke="#b91c1c" stroke-width="2" stroke-linecap="round"/></svg>
                    Не сдан
                  </span>
                {% endif %}
                <span class="text-sm text-blue-800 font-semibold">
                  {{ res.score|round(2) }} / {{ max_score|round(2) }} баллов{% if max_score > 0 %} ({{ percent }}%){% endif %}
                </span>
              </div>

              <!-- Прогресс-бар -->
              {% if max_score > 0 %}
              <div class="mt-3">
                <div class="h-2 w-full bg-white rounded-full border border-gray-200 overflow-hidden">
                  <div class="h-full {{ bar_color }} transition-[width] duration-500" style="width: {{ percent }}%"></div>
                </div>
                <div class="mt-1 text-[12px] text-gray-500">Порог «сдал» — {{ pass_threshold }}%</div>
              </div>
              {% endif %}

              <!-- Действия -->
              <div class="mt-auto pt-3 flex items-center">
                <a href="{{ url_for('user_tests.view_result', result_id=res.id) }}"
                   class="ml-auto text-blue-600 hover:text-violet-700 text-sm font-semibold">
                  Посмотреть результат →
                </a>
              </div>
            {% else %}
              <!-- Новый тест -->
              <div class="flex items-center gap-2 mt-auto">
                <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg bg-blue-50 text-blue-700 text-xs font-semibold">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="5" stroke="#2563eb" stroke-width="2"/></svg>
                  Новый
                </span>
                <a href="{{ url_for('user_tests.ready_test', test_id=test.id) }}"
                   class="ml-auto bg-gradient-to-tr from-blue-500 to-violet-600 hover:from-blue-600 hover:to-violet-700 text-white text-sm font-semibold px-4 py-2 rounded-xl shadow transition">
                  Пройти тест
                </a>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-gray-400 py-8 text-center">Пока что тесты не доступны.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
