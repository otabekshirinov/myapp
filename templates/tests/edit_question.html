{% extends 'base.html' %}
{% block title %}Редактировать вопрос{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto bg-white p-8 rounded-2xl shadow">
  <h2 class="text-2xl font-bold mb-6">Редактировать вопрос для теста "{{ question.test.title }}"</h2>
  <form method="post" id="qform">
    <div class="mb-4">
      <label class="block font-semibold mb-1">Текст вопроса</label>
      <input name="text" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 transition" maxlength="500"
             value="{{ question.text }}">
    </div>
    <div class="mb-4 flex items-center gap-4">
      <label class="block font-semibold mb-1">Варианты ответа</label>
      <button type="button" class="rounded-full bg-blue-500 text-white w-8 h-8 flex items-center justify-center text-xl shadow hover:bg-blue-600 focus:outline-none"
              onclick="addAnswer()">
        +
      </button>
      <button type="button" class="rounded-full bg-red-500 text-white w-8 h-8 flex items-center justify-center text-xl shadow hover:bg-red-600 focus:outline-none"
              onclick="removeAnswer()">
        &minus;
      </button>
    </div>
    <div id="answers-list" class="grid grid-cols-1 gap-4"></div>
    <button class="w-full mt-6 bg-blue-600 hover:bg-blue-700 text-white rounded py-2 font-semibold transition">
      Сохранить вопрос
    </button>
  </form>
</div>
<script>
  // Загружаем ответы из Jinja
  let answersData = [
    {% for a in question.answers %}
      {
        text: {{ a.text|tojson }},
        score: {{ a.score }},
        is_correct: {{ 'true' if a.is_correct else 'false' }}
      }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  let answerCount = answersData.length || 4;
  const minAnswers = 2, maxAnswers = 8;

  function renderAnswers() {
    const answersDiv = document.getElementById('answers-list');
    answersDiv.innerHTML = '';
    for (let i = 1; i <= answerCount; i++) {
      const answer = answersData[i-1] || {};
      answersDiv.innerHTML += `
        <div class="flex flex-col sm:flex-row items-end gap-2">
          <div class="flex-1 w-full">
            <label class="block font-semibold mb-1">Вариант ${i}</label>
            <input name="ans_${i}" required class="w-full border rounded px-3 py-2 focus:ring-2 focus:ring-blue-400 transition" maxlength="255"
              value="${answer.text !== undefined ? escapeHtml(answer.text) : ''}">
          </div>
          <div class="w-full sm:w-20">
            <label class="block font-semibold mb-1">Балл</label>
            <input name="score_${i}" required type="number" step="0.01" value="${answer.score !== undefined ? answer.score : 0}" class="w-full border rounded px-2 py-2 focus:ring-2 focus:ring-blue-400 transition">
          </div>
          <div class="flex flex-col items-center w-full sm:w-auto">
            <label class="block text-xs mb-1">Правильный</label>
            <input type="radio" name="correct" value="${i}" ${answer.is_correct ? 'checked' : (i===1 && answersData.length==0 ? 'checked' : '')}>
          </div>
        </div>
      `;
    }
  }
  function addAnswer() {
    if (answerCount < maxAnswers) {
      answersData.push({text: '', score: 0, is_correct: false});
      answerCount++;
      renderAnswers();
    }
  }
  function removeAnswer() {
    if (answerCount > minAnswers) {
      answersData.pop();
      answerCount--;
      renderAnswers();
    }
  }
  function escapeHtml(text) {
    var map = {
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
  }
  // Первичная отрисовка
  renderAnswers();
</script>
{% endblock %}
