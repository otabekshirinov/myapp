{% extends 'base.html' %}
{% block title %}Редактировать тест{% endblock %}

{% block content %}
<div class="max-w-xl mx-auto">
  <div
    class="bg-white/95 backdrop-blur p-8 rounded-2xl shadow-lg ring-1 ring-gray-100 transition-all duration-500 ease-out"
    x-data="{ title:'', desc:'', tl:0, qpa:0, maxTitle:255, maxDesc:1000 }"
    x-init="
      // подтягиваем значения, отрендеренные Jinja, чтобы Alpine знал стартовое состояние
      title = $refs.title.value;
      desc  = $refs.desc.value;
      tl    = parseInt($refs.tl.value)  || 0;
      qpa   = parseInt($refs.qpa.value) || 0;
    "
  >
    <div class="flex items-center gap-3 mb-6">
      <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 grid place-items-center shadow-inner">
        <svg width="24" height="24" viewBox="0 0 24 24" class="text-white">
          <path fill="currentColor" d="M5 4h14v2H5V4Zm0 4h14v2H5V8Zm0 4h9v2H5v-2Zm0 4h6v2H5v-2Z"/>
        </svg>
      </div>
      <h2 class="text-2xl font-extrabold tracking-tight">Редактировать тест</h2>
    </div>

    {% with msgs = get_flashed_messages(with_categories=true) %}
      {% if msgs %}
        <div class="mb-5 space-y-2">
          {% for cat, m in msgs %}
            <div class="px-3 py-2 rounded-lg border text-sm
              {% if cat in ['danger','error'] %}border-red-200 bg-red-50 text-red-800
              {% elif cat == 'success' %}border-green-200 bg-green-50 text-green-800
              {% else %}border-blue-200 bg-blue-50 text-blue-800{% endif %}">
              {{ m }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="post" id="editTestForm" novalidate>
      <!-- Название -->
      <div class="mb-5">
        <label class="block font-semibold mb-1">Название теста</label>
        <div class="relative group">
          <input
            name="title"
            x-ref="title"
            x-model="title"
            value="{{ test.title }}"
            required maxlength="255"
            class="peer w-full border border-gray-200 rounded-xl px-4 py-2.5 outline-none
                   focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition
                   placeholder:text-gray-400"
            placeholder="Например: Инструктаж по ТБ"
          />
          <div class="absolute right-3 top-1/2 -translate-y-1/2 opacity-0 group-focus-within:opacity-100 transition">
            <span class="text-xs text-gray-400" x-text="`${title.length} / ${maxTitle}`"></span>
          </div>
        </div>
      </div>

      <!-- Описание -->
      <div class="mb-5">
        <label class="block font-semibold mb-1">Описание</label>
        <div class="relative group">
          <textarea
            name="description"
            x-ref="desc"
            x-model="desc"
            maxlength="1000"
            rows="3"
            class="w-full border border-gray-200 rounded-xl px-4 py-3 outline-none resize-y
                   focus:ring-4 focus:ring-violet-100 focus:border-violet-400 transition
                   placeholder:text-gray-400"
            placeholder="Что это за тест, цели, критерии прохождения…"
          >{{ test.description }}</textarea>
          <div class="absolute right-3 bottom-2 opacity-60">
            <span class="text-xs text-gray-400" x-text="`${desc.length} / ${maxDesc}`"></span>
          </div>
        </div>
      </div>

      <!-- Ограничение по времени -->
      <div class="mb-5">
        <label class="block font-semibold mb-1">Ограничение по времени (минуты)</label>
        <div class="flex items-center gap-3">
          <input
            name="time_limit"
            type="number" min="0" max="240"
            x-ref="tl"
            x-model.number="tl"
            value="{{ test.time_limit or 0 }}"
            class="w-40 border border-gray-200 rounded-xl px-4 py-2.5 outline-none
                   focus:ring-4 focus:ring-emerald-100 focus:border-emerald-400 transition"
          />
          <span class="text-sm text-gray-500">0 — без ограничения (макс. 240 мин.)</span>
        </div>
      </div>

      <!-- Сколько вопросов показывать за попытку -->
      <div class="mb-7">
        <label class="block font-semibold mb-1 flex items-center gap-2">
          Сколько вопросов показывать за попытку
          <span class="text-[11px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200">опционально</span>
        </label>
        <div class="flex items-center gap-3">
          <input
            name="questions_per_attempt"
            type="number" min="0" step="1"
            x-ref="qpa" x-model.number="qpa"
            value="{{ test.questions_per_attempt or 0 }}"
            class="w-40 border border-gray-200 rounded-xl px-4 py-2.5 outline-none
                   focus:ring-4 focus:ring-indigo-100 focus:border-indigo-400 transition"
          />
          <span class="text-sm text-gray-500">
            0 — показать все вопросы теста. Сейчас в тесте:
            <b>{{ questions_count }}</b> вопросов.
          </span>
        </div>
      </div>

      <!-- Кнопки -->
      <div class="flex gap-3">
        <button
          type="submit"
          x-on:click.prevent="
            if (!title || title.trim().length === 0) { alert('Укажите название теста.'); return; }
            if (!Number.isInteger(tl) || tl < 0 || tl > 240) { alert('Ограничение по времени должно быть от 0 до 240 минут.'); return; }
            if (!Number.isInteger(qpa) || qpa < 0) { alert('Количество вопросов за попытку должно быть целым числом ≥ 0.'); return; }
            $root.querySelector('#editTestForm').submit();
          "
          class="relative inline-flex items-center justify-center px-5 py-2.5 rounded-xl font-semibold text-white
                 bg-gradient-to-r from-blue-600 to-violet-600 shadow-lg
                 hover:from-blue-700 hover:to-violet-700
                 focus:outline-none focus:ring-4 focus:ring-blue-200
                 transition active:scale-[.98]"
        >
          <span class="pr-6">Сохранить</span>
          <span class="absolute right-3 grid place-items-center translate-x-0 group-hover:translate-x-1 transition">
            <svg width="18" height="18" viewBox="0 0 20 20" class="opacity-90">
              <path d="M7 15l5-5-5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </button>

        <a href="{{ url_for('tests.view_test', test_id=test.id) }}"
           class="px-5 py-2.5 rounded-xl font-semibold text-gray-700 bg-gray-100 hover:bg-gray-200
                  focus:outline-none focus:ring-4 focus:ring-gray-200 transition">
          Отмена
        </a>
      </div>
    </form>
  </div>
</div>
{% endblock %}
